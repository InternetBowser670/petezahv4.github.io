<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <!-- Google Material Icons -->
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <style>
      @import url("https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500&display=swap");
      *{margin:0;padding:0;box-sizing:border-box;font-family:Roboto,sans-serif}
      :root{
        --text-color:#e0e7ff;
        --primary-bg:#1a2639;
        --secondary-bg:#2c3e50;
        --accent-bg:#3b5998;
        --hover-bg:#4a6fb3;
        --border-color:#4a6fb3;
        --placeholder-color:#a3bffa;
        --button-bg:#6366f1;
        --button-hover-bg:#818cf8;
      }
      body{
        color:var(--text-color);
        background:var(--primary-bg);
        display:flex;
        flex-direction:column;
        min-height:100vh;
      }
      .container{
        flex:1;
        padding:20px;
        overflow-y:auto;
        scrollbar-width:thin;
        scrollbar-color:var(--border-color) transparent;
      }
      .container::-webkit-scrollbar{
        width:8px;
      }
      .container::-webkit-scrollbar-thumb{
        background:var(--border-color);
        border-radius:4px;
      }
      .container::-webkit-scrollbar-track{
        background:transparent;
      }
      .suggestions{
        display:flex;
        gap:10px;
        margin:20px 0;
        overflow-x:auto;
        padding-bottom:10px;
        scrollbar-width:none;
      }
      .suggestions::-webkit-scrollbar{
        display:none;
      }
      body.chats-active .suggestions{
        display:none;
      }
      .suggestions .suggestions-item{
        cursor:pointer;
        padding:15px;
        background:var(--secondary-bg);
        border-radius:10px;
        flex:0 0 200px;
        transition:transform 0.2s, background 0.2s;
        box-shadow:0 2px 5px rgba(0,0,0,0.2);
      }
      .suggestions .suggestions-item:hover{
        transform:translateY(-3px);
        background:var(--hover-bg);
      }
      .suggestions .suggestions-item .text{
        font-size:0.95rem;
        margin-bottom:10px;
      }
      .suggestions .suggestions-item .icon{
        display:flex;
        align-items:center;
        justify-content:center;
        width:40px;
        height:40px;
        background:var(--accent-bg);
        border-radius:50%;
        color:#fff;
      }
      .suggestions .suggestions-item:nth-child(2) .icon{color:#ffeb3b}
      .suggestions .suggestions-item:nth-child(3) .icon{color:#4caf50}
      .suggestions .suggestions-item:nth-child(4) .icon{color:#ab47bc}
      .chats-container{
        display:flex;
        flex-direction:column;
        gap:15px;
      }
      .message{
        display:flex;
        gap:10px;
        align-items:flex-start;
      }
      .message .avatar{
        width:40px;
        height:40px;
        border-radius:50%;
        background:var(--secondary-bg);
        display:flex;
        align-items:center;
        justify-content:center;
        font-size:1.2rem;
        color:#fff;
        flex-shrink:0;
      }
      .message.loading .avatar{
        animation:3s linear infinite rotate;
      }
      @keyframes rotate{
        100%{transform:rotate(360deg)}
      }
      .message .message-content{
        flex:1;
        background:var(--secondary-bg);
        padding:10px 15px;
        border-radius:12px;
        box-shadow:0 1px 3px rgba(0,0,0,0.1);
      }
      .message .message-text{
        font-size:0.95rem;
        line-height:1.5;
        white-space:pre-wrap;
      }
      .bot-message .message-content{
        background:var(--accent-bg);
      }
      .user-message{
        flex-direction:row-reverse;
      }
      .user-message .message-content{
        background:var(--secondary-bg);
        border-radius:12px;
      }
      .user-message .img-attachment{
        margin-top:5px;
        width:60%;
        border-radius:10px;
      }
      .user-message .file-attachment{
        display:flex;
        gap:5px;
        align-items:center;
        padding:8px;
        margin-top:5px;
        border-radius:10px;
        background:var(--secondary-bg);
        font-size:0.9rem;
      }
      .user-message .file-attachment span{
        color:#6366f1;
      }
      .prompt-container{
        padding:15px;
        background:var(--primary-bg);
        border-top:1px solid var(--border-color);
      }
      .prompt-wrapper{
        display:flex;
        gap:10px;
        align-items:center;
      }
      .prompt-form{
        flex:1;
        display:flex;
        align-items:center;
        background:var(--secondary-bg);
        border-radius:30px;
        padding:5px 10px;
      }
      .prompt-input{
        flex:1;
        background:none;
        border:none;
        outline:none;
        color:var(--text-color);
        font-size:0.95rem;
        padding:10px;
      }
      .prompt-input::placeholder{
        color:var(--placeholder-color);
      }
      .prompt-actions{
        display:flex;
        gap:5px;
      }
      .prompt-wrapper button{
        width:40px;
        height:40px;
        border-radius:50%;
        background:var(--secondary-bg);
        border:none;
        color:var(--text-color);
        cursor:pointer;
        transition:background 0.2s;
        display:flex;
        align-items:center;
        justify-content:center;
      }
      .prompt-wrapper button:hover{
        background:var(--hover-bg);
      }
      .prompt-form #send-prompt-btn{
        display:none;
        background:var(--button-bg);
      }
      .prompt-form .prompt-input:valid~.prompt-actions #send-prompt-btn{
        display:flex;
      }
      .prompt-form #send-prompt-btn:hover{
        background:var(--button-hover-bg);
      }
      .prompt-form #stop-response-btn{
        display:none;
      }
      body.bot-responding .prompt-form #stop-response-btn{
        display:flex;
      }
      body.bot-responding .prompt-form .file-upload-wrapper{
        display:none;
      }
      .prompt-form .file-upload-wrapper{
        position:relative;
        width:40px;
        height:40px;
      }
      .prompt-form .file-upload-wrapper #add-file-btn{
        display:flex;
        align-items:center;
        justify-content:center;
        width:100%;
        height:100%;
        background:none;
        border:none;
        color:var(--text-color);
        cursor:pointer;
      }
      .prompt-form .file-upload-wrapper.active #add-file-btn{
        display:none;
      }
      .prompt-form .file-upload-wrapper.active #cancel-file-btn{
        display:flex;
      }
      .prompt-form .file-upload-wrapper #cancel-file-btn{
        display:none;
        align-items:center;
        justify-content:center;
        width:100%;
        height:100%;
        background:none;
        border:none;
        color:#ef4444;
        cursor:pointer;
      }
      .prompt-form .file-upload-wrapper.active.file-attached .file-icon,
      .prompt-form .file-upload-wrapper.active.img-attached img{
        display:block;
      }
      .prompt-form .file-upload-wrapper img{
        width:100%;
        height:100%;
        object-fit:cover;
        border-radius:8px;
      }
      .material-icons{
        font-size:20px;
      }
      .bot-message .buttons{
        display:flex;
        gap:8px;
        margin-top:5px;
        justify-content:flex-end;
      }
      .bot-message .buttons button{
        width:35px;
        height:35px;
        background:var(--secondary-bg);
        color:var(--text-color);
        border:none;
        border-radius:50%;
        cursor:pointer;
        transition:background 0.2s;
        display:flex;
        align-items:center;
        justify-content:center;
      }
      .bot-message .buttons button:hover{
        background:var(--hover-bg);
      }
      .code-grid{
        background:#34495e;
        padding:10px;
        border-radius:8px;
        margin-top:5px;
        white-space:pre-wrap;
        font-family:monospace;
        font-size:0.9rem;
        color:#f8f8f2;
        border:1px solid var(--border-color);
      }
      @media (max-width:768px){
        .container{padding:15px}
        .suggestions .suggestions-item{flex:0 0 180px}
        .prompt-wrapper button{width:35px;height:35px}
        .prompt-form .file-upload-wrapper{width:35px;height:35px}
        .prompt-form .prompt-input{padding:8px}
      }
    </style>
  </head>

  <body>
    <div class="container">
      <ul class="suggestions">
        <li class="suggestions-item">
          <p class="text">Compose an article about canines.</p>
          <span class="icon"><i class="material-icons">edit</i></span>
        </li>
        <li class="suggestions-item">
          <p class="text">Propose an innovative craft concept.</p>
          <span class="icon"><i class="material-icons">lightbulb</i></span>
        </li>
        <li class="suggestions-item">
          <p class="text">Assist with organizing a short trip.</p>
          <span class="icon"><i class="material-icons">map</i></span>
        </li>
        <li class="suggestions-item">
          <p class="text">Create a basic task manager in Python.</p>
          <span class="icon"><i class="material-icons">code</i></span>
        </li>
      </ul>
      <div class="chats-container"></div>
      <div class="prompt-container">
        <div class="prompt-wrapper">
          <form action="#" class="prompt-form">
            <input
              type="text"
              placeholder="Ask anything..."
              class="prompt-input"
              required
            />
            <div class="prompt-actions">
              <div class="file-upload-wrapper">
                <img src="#" class="file-preview" />
                <input
                  id="file-input"
                  type="file"
                  accept="image/*, .pdf, .txt, .csv"
                  hidden
                />
                <button type="button">
                  <i class="material-icons">arrow_forward</i>
                </button>
                <button id="cancel-file-btn" type="button">
                  <i class="material-icons">attach_file</i>
                </button>
                <button id="add-file-btn" type="button">
                  <i class="material-icons">attach_file</i>
                </button>
              </div>
              <button id="stop-response-btn" type="button">
                <i class="material-icons">stop</i>
              </button>
              <button id="send-prompt-btn">
                <i class="material-icons">arrow_forward</i>
              </button>
            </div>
          </form>
          <button id="delete-chats-btn">
            <i class="material-icons">delete</i>
          </button>
        </div>
      </div>
    </div>
    <script>
      const PeteAIKey = "AIzaSyC-t9UqpXINmssoIb8vNiMMU8ZOYss7cKY"; // Replace with your valid API key
      const container = document.querySelector(".container"),
            chatsContainer = document.querySelector(".chats-container"),
            promptForm = document.querySelector(".prompt-form"),
            promptInput = promptForm.querySelector(".prompt-input"),
            fileInput = promptForm.querySelector("#file-input"),
            fileUploadWrapper = document.querySelector(".file-upload-wrapper"),
            API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${PeteAIKey}`;
      let controller, typingInterval;
      const chatHistory = [], userData = { message: "", file: {} };

      const createMessageElement = (e, ...t) => {
        const a = document.createElement("div");
        a.classList.add("message", ...t);
        a.innerHTML = e;
        return a;
      };

      const scrollToBottom = () => container.scrollTo({ top: container.scrollHeight, behavior: "smooth" });

      const typingEffect = (text, element, callback) => {
        element.textContent = "";
        let i = 0;
        typingInterval = setInterval(() => {
          if (i < text.length) {
            element.textContent += text[i++];
            scrollToBottom();
          } else {
            clearInterval(typingInterval);
            callback();
          }
        }, 20);
      };

      const formatResponse = (text, messageElement) => {
        const codeBlockRegex = /```(\w*)\n([\s\S]*?)```/g;
        const parts = [];
        let lastIndex = 0;
        let match;

        while ((match = codeBlockRegex.exec(text)) !== null) {
          if (match.index > lastIndex) {
            parts.push({ type: "text", content: text.slice(lastIndex, match.index).trim() });
          }
          parts.push({ type: "code", language: match[1] || "plaintext", content: match[2].trim() });
          lastIndex = codeBlockRegex.lastIndex;
        }

        if (lastIndex < text.length) {
          parts.push({ type: "text", content: text.slice(lastIndex).trim() });
        }

        if (parts.length === 0) {
          parts.push({ type: "text", content: text });
        }

        let html = '<div class="message-content">';
        parts.forEach(part => {
          if (part.type === "text") {
            html += `<p class="message-text">${part.content}</p>`;
          } else {
            html += `<pre class="code-grid">${part.content}</pre>`;
          }
        });
        html += '</div><div class="buttons"></div>';

        messageElement.innerHTML = html;
        return parts;
      };

      const addButtons = (messageElement, text) => {
        const buttonsDiv = messageElement.querySelector(".buttons");

        const copyBtn = document.createElement("button");
        copyBtn.innerHTML = '<i class="material-icons">content_copy</i>';
        copyBtn.onclick = () => {
          navigator.clipboard.writeText(text).then(() => {
            copyBtn.innerHTML = '<i class="material-icons">check</i>';
            setTimeout(() => (copyBtn.innerHTML = '<i class="material-icons">content_copy</i>'), 1500);
          });
        };

        const redoBtn = document.createElement("button");
        redoBtn.innerHTML = '<i class="material-icons">refresh</i>';
        redoBtn.onclick = () => {
          const lastUserMessage = chatHistory[chatHistory.length - 2]?.parts[0].text;
          if (lastUserMessage) {
            userData.message = lastUserMessage;
            document.body.classList.add("bot-responding");
            const newBotMessage = createMessageElement('<div class="message-content"><p class="message-text">...</p></div>', "bot-message", "loading");
            chatsContainer.appendChild(newBotMessage);
            scrollToBottom();
            generateResponse(newBotMessage);
          }
        };

        buttonsDiv.appendChild(copyBtn);
        buttonsDiv.appendChild(redoBtn);
      };

      const generateResponse = async (messageElement) => {
        controller = new AbortController;
        chatHistory.push({ role: "user", parts: [{ text: userData.message }, ...userData.file.data ? [{ inline_data: (({ fileName: e, isImage: t, ...a }) => a)(userData.file) }] : []] });
        try {
          const response = await fetch(API_URL, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ contents: chatHistory }),
            signal: controller.signal
          });
          if (!response.ok) throw new Error((await response.json()).error.message);
          const data = await response.json();
          const responseText = data.candidates[0].content.parts[0].text.replace(/\*\*([^*]+)\*\*/g, "$1").trim();
          const parts = formatResponse(responseText, messageElement);
          
          const textParts = parts.filter(part => part.type === "text");
          let currentTextIndex = 0;

          const animateNextText = () => {
            if (currentTextIndex < textParts.length) {
              const textElement = messageElement.querySelectorAll(".message-text")[currentTextIndex];
              if (textElement) {
                typingEffect(textParts[currentTextIndex].content, textElement, () => {
                  currentTextIndex++;
                  animateNextText();
                });
              } else {
                currentTextIndex++;
                animateNextText();
              }
            } else {
              messageElement.classList.remove("loading");
              document.body.classList.remove("bot-responding");
              addButtons(messageElement, responseText);
              scrollToBottom();
            }
          };

          animateNextText();
          chatHistory.push({ role: "model", parts: [{ text: responseText }] });
        } catch (error) {
          const textElement = messageElement.querySelector(".message-text");
          textElement.textContent = error.name === "AbortError" ? "Response generation stopped." : error.message;
          textElement.style.color = "#ef4444";
          messageElement.classList.remove("loading");
          document.body.classList.remove("bot-responding");
          scrollToBottom();
        } finally {
          userData.file = {};
        }
      };

      const handleFormSubmit = (e) => {
        e.preventDefault();
        const prompt = promptInput.value.trim();
        if (!prompt || document.body.classList.contains("bot-responding")) return;
        userData.message = prompt;
        promptInput.value = "";
        document.body.classList.add("chats-active", "bot-responding");
        fileUploadWrapper.classList.remove("file-attached", "img-attached", "active");
        const userContent = `
          <div class="message-content">
            <p class="message-text">${userData.message}</p>
            ${userData.file.data ? userData.file.isImage ? `<img src="data:${userData.file.mime_type};base64,${userData.file.data}" class="img-attachment" />` : `<p class="file-attachment"><span class="material-symbols-rounded">description</span>${userData.file.fileName}</p>` : ""}
          </div>
        `;
        const userMessage = createMessageElement(userContent, "user-message");
        chatsContainer.appendChild(userMessage);
        scrollToBottom();
        setTimeout(() => {
          const botMessage = createMessageElement('<div class="message-content"><p class="message-text">...</p></div>', "bot-message", "loading");
          chatsContainer.appendChild(botMessage);
          scrollToBottom();
          generateResponse(botMessage);
        }, 600);
      };

      fileInput.addEventListener("change", () => {
        const file = fileInput.files[0];
        if (!file) return;
        const isImage = file.type.startsWith("image/");
        const reader = new FileReader();
        reader.readAsDataURL(file);
        reader.onload = (e) => {
          fileInput.value = "";
          const data = e.target.result.split(",")[1];
          fileUploadWrapper.querySelector(".file-preview").src = e.target.result;
          fileUploadWrapper.classList.add("active", isImage ? "img-attached" : "file-attached");
          userData.file = { fileName: file.name, data: data, mime_type: file.type, isImage: isImage };
        };
      });

      document.querySelector("#cancel-file-btn").addEventListener("click", () => {
        userData.file = {};
        fileUploadWrapper.classList.remove("file-attached", "img-attached", "active");
      });

      document.querySelector("#stop-response-btn").addEventListener("click", () => {
        controller?.abort();
        userData.file = {};
        clearInterval(typingInterval);
        const loadingMessage = chatsContainer.querySelector(".bot-message.loading");
        if (loadingMessage) loadingMessage.classList.remove("loading");
        document.body.classList.remove("bot-responding");
      });

      document.querySelector("#delete-chats-btn").addEventListener("click", () => {
        chatHistory.length = 0;
        chatsContainer.innerHTML = "";
        document.body.classList.remove("chats-active", "bot-responding");
      });

      document.querySelectorAll(".suggestions-item").forEach((item) => {
        item.addEventListener("click", () => {
          promptInput.value = item.querySelector(".text").textContent;
          promptForm.dispatchEvent(new Event("submit"));
        });
      });

      document.addEventListener("click", ({ target }) => {
        const wrapper = document.querySelector(".prompt-wrapper");
        const shouldHide = target.classList.contains("prompt-input") || wrapper.classList.contains("hide-controls") && (target.id === "add-file-btn" || target.id === "stop-response-btn");
        wrapper.classList.toggle("hide-controls", shouldHide);
      });

      promptForm.addEventListener("submit", handleFormSubmit);
      promptForm.querySelector("#add-file-btn").addEventListener("click", () => fileInput.click());
    </script>
  </body>
</html>
